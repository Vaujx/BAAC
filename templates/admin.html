<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BAAC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #e53935;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .logout-btn {
            background-color: #e53935;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        .logout-btn:hover {
            background-color: #c62828;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f5f5f5;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab-button.active {
            background-color: #e53935;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Document Management Styles */
        .document-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .document-table th, 
        .document-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .document-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        .document-table tr:hover {
            background-color: #f9f9f9;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending {
            background-color: #FFF3CD;
            color: #856404;
        }
        .status-approved {
            background-color: #D4EDDA;
            color: #155724;
        }
        .status-rejected {
            background-color: #F8D7DA;
            color: #721C24;
        }
        .status-claimed {
            background-color: #CCE5FF;
            color: #004085;
        }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 5px;
            font-size: 12px;
        }
        .approve-btn {
            background-color: #28A745;
            color: white;
        }
        .reject-btn {
            background-color: #DC3545;
            color: white;
        }
        .claim-btn {
            background-color: #007BFF;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 50%;
            max-width: 500px;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 100px;
        }
        .submit-btn {
            background-color: #e53935;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .submit-btn:hover {
            background-color: #c62828;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button.active {
            background-color: #e53935;
            color: white;
            border-color: #e53935;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .search-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .filter-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }
        
        /* Settings Tab Styles */
        .settings-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Date Range Selector Styles */
        .date-range-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .date-range-selector .form-group {
            margin-bottom: 0;
        }

        /* Report Options Styles */
        .report-options {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .report-options h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #e53935;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
        }

        .report-actions {
            display: flex;
            gap: 10px;
        }

        /* Graph container for reports */
        .report-graph {
            margin: 15px 0;
            height: 300px;
            width: 100%;
        }

        .report-container {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            min-height: 200px;
        }

        .report-section {
            margin-bottom: 20px;
        }

        .report-section h4 {
            margin-bottom: 10px;
            color: #e53935;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .report-table th, 
        .report-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .report-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .ai-insights {
            background-color: #f8f9fa;
            border-left: 3px solid #e53935;
            padding: 15px;
            margin: 15px 0;
        }

        /* Print styles */
        @media print {
            /* Hide everything except the report */
            body * {
                visibility: hidden;
            }
            
            /* Make the report container and its contents visible */
            #customReportContainer, 
            #customReportContainer * {
                visibility: visible;
            }
            
            /* Position the report at the top of the page */
            #customReportContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background-color: white;
                padding: 20px;
            }
            
            /* Hide UI elements that shouldn't be printed */
            .main-header, 
            .tab-buttons, 
            .date-range-selector, 
            .report-options, 
            #printReportBtn,
            #refreshReportBtn,
            #generateReportBtn {
                display: none !important;
            }
            
            /* Ensure graphs print properly */
            .report-graph {
                break-inside: avoid;
                page-break-inside: avoid;
                height: 300px !important;
                width: 100% !important;
                margin: 20px 0;
                display: block !important;
            }
            
            /* Make sure canvas elements are visible */
            canvas {
                display: block !important;
                visibility: visible !important;
                height: auto !important;
                max-width: 100% !important;
            }
            
            /* Ensure tables break properly between pages */
            .report-table {
                page-break-inside: auto;
                width: 100%;
            }
            
            .report-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            .report-section {
                page-break-inside: avoid;
                margin-bottom: 30px;
            }
            
            /* Add page breaks before sections */
            .report-section {
                page-break-before: auto;
            }
            
            /* Ensure text is black for better printing */
            body {
                color: black;
            }
            
            /* Ensure background colors print */
            .report-section, .ai-insights, .report-table th {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo">
            <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" stroke="white" stroke-width="10"/>
                <path d="M30 50L70 50M50 30L50 70" stroke="white" stroke-width="10" stroke-linecap="round"/>
            </svg>
        </div>
        <h1>BAAC - Admin Dashboard</h1>
    </header>

    <div class="admin-container">
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="dashboard">Dashboard</button>
                <button class="tab-button" data-tab="documents">Document Management</button>
                <button class="tab-button" data-tab="settings">Settings</button>
            </div>
            
            <div id="dashboard" class="tab-content active">
                <h2>Today's Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Website Visits</h3>
                        <p id="todayVisits">Loading...</p>
                    </div>
                    <div class="stat-card">
                        <h3>Document Requests</h3>
                        <p id="todayRequests">Loading...</p>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Website Visits (Last 7 Days)</h3>
                    <canvas id="visitsChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Document Requests (Last 7 Days)</h3>
                    <canvas id="requestsChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Document Requests by Type (Last 30 Days)</h3>
                    <canvas id="documentTypesChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Document Requests by Status</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Custom Date Range Report</h3>
                    <div class="date-range-selector">
                        <div class="form-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate" value="{{ (now - timedelta(days=7)).strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date:</label>
                            <input type="date" id="endDate" value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                    </div>
                    
                    <div class="report-options">
                        <h4>Select sections to include in report:</h4>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeVisits" checked>
                                <label for="includeVisits">Website Visits</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeDocRequests" checked>
                                <label for="includeDocRequests">Document Requests</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeDocStatus" checked>
                                <label for="includeDocStatus">Document Status</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeAiInsights" checked>
                                <label for="includeAiInsights">AI Insights</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeUserQueries" checked>
                                <label for="includeUserQueries">Common User Queries</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeGraphs" checked>
                                <label for="includeGraphs">Include Graphs</label>
                            </div>
                        </div>
                        <div class="report-actions">
                            <button id="refreshReportBtn" class="action-btn">Refresh Report</button>
                            <button id="generateReportBtn" class="action-btn">Generate Report</button>
                            <button id="printReportBtn" class="action-btn" disabled>Print Report</button>
                        </div>
                    </div>
                    
                    <div id="customReportContainer" class="report-container">
                        <p>Select a date range and click "Generate Report" to view statistics.</p>
                    </div>
                </div>
            </div>
            
            <div id="documents" class="tab-content">
                <h2>Document Management</h2>
                
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by name or reference number...">
                    <select id="statusFilter" class="filter-select">
                        <option value="all">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Claimed">Claimed</option>
                    </select>
                    <select id="typeFilter" class="filter-select">
                        <option value="all">All Types</option>
                        <option value="barangay clearance">Barangay Clearance</option>
                        <option value="barangay residency">Barangay Residency</option>
                        <option value="barangay indigency">Barangay Indigency</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table class="document-table" id="documentTable">
                        <thead>
                            <tr>
                                <th>Ref #</th>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Purok</th>
                                <th>Purpose</th>
                                <th>Copies</th>
                                <th>Date Requested</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documentTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center;">Loading document requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="documentPagination">
                    <!-- Pagination buttons will be added here -->
                </div>
            </div>
            
            <div id="settings" class="tab-content">
                <h2>Admin Settings</h2>
                
                <div class="settings-card">
                    <h3>Change Admin Credentials</h3>
                    <form id="adminCredentialsForm">
                        <div class="form-group">
                            <label for="currentKey">Current Admin Key:</label>
                            <input type="text" id="currentKey" required>
                        </div>
                        <div class="form-group">
                            <label for="currentPass">Current Admin Password:</label>
                            <input type="password" id="currentPass" required>
                        </div>
                        <div class="form-group">
                            <label for="newKey">New Admin Key:</label>
                            <input type="text" id="newKey" required>
                        </div>
                        <div class="form-group">
                            <label for="newPass">New Admin Password:</label>
                            <input type="password" id="newPass" required>
                        </div>
                        <button type="submit" class="submit-btn">Update Credentials</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Update Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <h3 id="modalTitle">Update Document Status</h3>
            <form id="statusUpdateForm">
                <input type="hidden" id="documentId">
                <input type="hidden" id="statusAction">
                
                <div class="form-group">
                    <label for="notes">Notes (optional):</label>
                    <textarea id="notes" placeholder="Add any notes or comments about this status change"></textarea>
                </div>
                
                <button type="submit" class="submit-btn">Update Status</button>
            </form>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 BAAC - Barangay Amungan Assistant Chatbot. All rights reserved.</p>
    </footer>

    <script>
        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // If documents tab is clicked, load document requests
                    if (tabId === 'documents') {
                        loadDocumentRequests();
                    }
                });
            });
            
            // Dashboard charts and stats
            fetchAdminStats();
            
            // Document management
            setupDocumentManagement();
            
            // Admin Settings
            setupAdminSettings();
            
            // Custom Report
            setupCustomReport();
            
            // Setup checkbox event listeners to refresh the report when options change
            document.getElementById('includeVisits').addEventListener('change', refreshReportIfDataExists);
            document.getElementById('includeDocRequests').addEventListener('change', refreshReportIfDataExists);
            document.getElementById('includeDocStatus').addEventListener('change', refreshReportIfDataExists);
            document.getElementById('includeAiInsights').addEventListener('change', refreshReportIfDataExists);
            document.getElementById('includeUserQueries').addEventListener('change', refreshReportIfDataExists);
            document.getElementById('includeGraphs').addEventListener('change', refreshReportIfDataExists);
        });
        
        // Store the last report data to avoid unnecessary API calls
        let lastReportData = null;
        let lastStartDate = null;
        let lastEndDate = null;
        
        function refreshReportIfDataExists() {
            if (lastReportData) {
                renderCustomReport(lastReportData, lastStartDate, lastEndDate);
            }
        }
        
        function fetchAdminStats() {
            fetch('/admin_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('todayVisits').textContent = data.today_visits;
                    document.getElementById('todayRequests').textContent = data.today_requests;

                    createLineChart('visitsChart', 'Website Visits', data.visits_data, 'visit_date', 'visit_count');
                    createLineChart('requestsChart', 'Document Requests', data.requests_data, 'request_date', 'total_requests');
                    
                    if (data.document_types_data) {
                        createBarChart('documentTypesChart', data.document_types_data, 'document_type', 'total_requests', 'Document Type', 'Number of Requests');
                    }
                    
                    if (data.status_data) {
                        createBarChart('statusChart', data.status_data, 'status', 'count', 'Status', 'Number of Documents');
                    }
                })
                .catch(error => console.error('Error fetching admin stats:', error));
        }

        function createLineChart(canvasId, label, data, dateField, valueField) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item[dateField]),
                    datasets: [{
                        label: label,
                        data: data.map(item => item[valueField]),
                        borderColor: 'rgb(229, 57, 53)',
                        backgroundColor: 'rgba(229, 57, 53, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createBarChart(canvasId, data, labelField, valueField, xAxisLabel, yAxisLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item[labelField]),
                    datasets: [{
                        label: yAxisLabel,
                        data: data.map(item => item[valueField]),
                        backgroundColor: [
                            'rgba(229, 57, 53, 0.7)',
                            'rgba(198, 40, 40, 0.7)',
                            'rgba(183, 28, 28, 0.7)',
                            'rgba(136, 14, 79, 0.7)'
                        ],
                        borderColor: [
                            'rgb(229, 57, 53)',
                            'rgb(198, 40, 40)',
                            'rgb(183, 28, 28)',
                            'rgb(136, 14, 79)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            title: {
                                display: true,
                                text: xAxisLabel
                            }
                        }
                    }
                }
            });
        }
        
        // Document Management
        function setupDocumentManagement() {
            // Modal elements
            const modal = document.getElementById('statusModal');
            const closeModal = document.getElementById('closeModal');
            const statusUpdateForm = document.getElementById('statusUpdateForm');
            
            // Search and filter elements
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            
            // Close modal when clicking the X
            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Handle status update form submission
            statusUpdateForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const documentId = document.getElementById('documentId').value;
                const status = document.getElementById('statusAction').value;
                const notes = document.getElementById('notes').value;
                
                updateDocumentStatus(documentId, status, notes);
            });
            
            // Handle search and filters
            searchInput.addEventListener('input', filterDocuments);
            statusFilter.addEventListener('change', filterDocuments);
            typeFilter.addEventListener('change', filterDocuments);
        }
        
        let allDocuments = []; // Store all documents for filtering
        let currentPage = 1;
        const documentsPerPage = 10;
        
        function loadDocumentRequests() {
            fetch('/admin/document_requests')
                .then(response => response.json())
                .then(data => {
                    allDocuments = data;
                    displayDocuments(allDocuments, currentPage);
                    setupPagination(allDocuments.length);
                })
                .catch(error => console.error('Error fetching document requests:', error));
        }
        
        function displayDocuments(documents, page) {
            const tableBody = document.getElementById('documentTableBody');
            tableBody.innerHTML = '';
            
            if (documents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No document requests found</td></tr>';
                return;
            }
            
            // Calculate pagination
            const startIndex = (page - 1) * documentsPerPage;
            const endIndex = startIndex + documentsPerPage;
            const paginatedDocs = documents.slice(startIndex, endIndex);
            
            paginatedDocs.forEach(doc => {
                const row = document.createElement('tr');
                
                // Format date for display
                const requestDate = new Date(doc.submission_date).toLocaleDateString();
                
                // Create status badge
                const statusBadge = `<span class="status-badge status-${doc.status.toLowerCase()}">${doc.status}</span>`;
                
                // Create action buttons based on current status
                let actionButtons = '';
                
                if (doc.status === 'Pending') {
                    actionButtons = `
                        <button class="action-btn approve-btn" onclick="showStatusModal(${doc.id}, 'Approved')">Approve</button>
                        <button class="action-btn reject-btn" onclick="showStatusModal(${doc.id}, 'Rejected')">Reject</button>
                    `;
                } else if (doc.status === 'Approved') {
                    actionButtons = `
                        <button class="action-btn claim-btn" onclick="showStatusModal(${doc.id}, 'Claimed')">Mark as Claimed</button>
                    `;
                }
                
                row.innerHTML = `
                    <td>REF-${doc.id}</td>
                    <td>${doc.document_type.charAt(0).toUpperCase() + doc.document_type.slice(1)}</td>
                    <td>${doc.name}</td>
                    <td>${doc.purok}</td>
                    <td>${doc.purpose}</td>
                    <td>${doc.copies || 'N/A'}</td>
                    <td>${requestDate}</td>
                    <td>${statusBadge}</td>
                    <td>${actionButtons}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function setupPagination(totalDocuments) {
            const paginationContainer = document.getElementById('documentPagination');
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(totalDocuments / documentsPerPage);
            
            if (totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.textContent = '←';
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayDocuments(allDocuments, currentPage);
                    updatePaginationButtons();
                }
            });
            paginationContainer.appendChild(prevButton);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPage);
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    displayDocuments(allDocuments, currentPage);
                    updatePaginationButtons();
                });
                paginationContainer.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.textContent = '→';
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayDocuments(allDocuments, currentPage);
                    updatePaginationButtons();
                }
            });
            paginationContainer.appendChild(nextButton);
        }
        
        function updatePaginationButtons() {
            const buttons = document.querySelectorAll('#documentPagination button');
            buttons.forEach((button, index) => {
                // Skip first and last buttons (prev/next)
                if (index === 0 || index === buttons.length - 1) return;
                
                const pageNum = parseInt(button.textContent);
                button.classList.toggle('active', pageNum === currentPage);
            });
        }
        
        function filterDocuments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            let filteredDocs = allDocuments.filter(doc => {
                // Search term filter
                const matchesSearch = 
                    doc.name.toLowerCase().includes(searchTerm) || 
                    (`REF-${doc.id}`).toLowerCase().includes(searchTerm);
                
                // Status filter
                const matchesStatus = statusFilter === 'all' || doc.status === statusFilter;
                
                // Type filter
                const matchesType = typeFilter === 'all' || doc.document_type === typeFilter;
                
                return matchesSearch && matchesStatus && matchesType;
            });
            
            currentPage = 1; // Reset to first page when filtering
            displayDocuments(filteredDocs, currentPage);
            setupPagination(filteredDocs.length);
        }
        
        function showStatusModal(documentId, status) {
            const modal = document.getElementById('statusModal');
            const modalTitle = document.getElementById('modalTitle');
            
            document.getElementById('documentId').value = documentId;
            document.getElementById('statusAction').value = status;
            document.getElementById('notes').value = '';
            
            // Set modal title based on action
            if (status === 'Approved') {
                modalTitle.textContent = 'Approve Document Request';
            } else if (status === 'Rejected') {
                modalTitle.textContent = 'Reject Document Request';
            } else if (status === 'Claimed') {
                modalTitle.textContent = 'Mark Document as Claimed';
            }
            
            modal.style.display = 'block';
        }
        
        function updateDocumentStatus(documentId, status, notes) {
            fetch('/admin/update_document_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: documentId,
                    status: status,
                    notes: notes
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    document.getElementById('statusModal').style.display = 'none';
                    
                    // Reload document requests
                    loadDocumentRequests();
                    
                    // Refresh dashboard stats
                    fetchAdminStats();
                    
                    // Show success message
                    alert(`Document status updated to ${status}`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to update document status'));
                }
            })
            .catch(error => {
                console.error('Error updating document status:', error);
                alert('Error updating document status. Please try again.');
            });
        }
        
        // Admin Settings
        function setupAdminSettings() {
            const adminCredentialsForm = document.getElementById('adminCredentialsForm');
            
            adminCredentialsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentKey = document.getElementById('currentKey').value;
                const currentPass = document.getElementById('currentPass').value;
                const newKey = document.getElementById('newKey').value;
                const newPass = document.getElementById('newPass').value;
                
                fetch('/admin/update_credentials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        currentKey: currentKey,
                        currentPass: currentPass,
                        newKey: newKey,
                        newPass: newPass
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Admin credentials updated successfully!');
                        adminCredentialsForm.reset();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to update credentials'));
                    }
                })
                .catch(error => {
                    console.error('Error updating credentials:', error);
                    alert('Error updating credentials. Please try again.');
                });
            });
        }
        
        // Custom Date Range Report
        function setupCustomReport() {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const refreshReportBtn = document.getElementById('refreshReportBtn');
            const printReportBtn = document.getElementById('printReportBtn');
            
            generateReportBtn.addEventListener('click', function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                // Disable the button while loading
                this.disabled = true;
                this.textContent = 'Loading...';
                
                fetch('/admin/custom_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        startDate: startDate,
                        endDate: endDate
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store the data for refreshing without API call
                        lastReportData = data;
                        lastStartDate = startDate;
                        lastEndDate = endDate;
                        
                        renderCustomReport(data, startDate, endDate);
                        printReportBtn.disabled = false;
                    } else {
                        alert('Error: ' + (data.error || 'Failed to generate report'));
                        document.getElementById('customReportContainer').innerHTML = 
                            '<p>Error generating report. Please try again.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error generating report:', error);
                    document.getElementById('customReportContainer').innerHTML = 
                        '<p>Error generating report. Please try again.</p>';
                })
                .finally(() => {
                    // Re-enable the button
                    this.disabled = false;
                    this.textContent = 'Generate Report';
                });
            });
            
            refreshReportBtn.addEventListener('click', function() {
                if (lastReportData) {
                    renderCustomReport(lastReportData, lastStartDate, lastEndDate);
                } else {
                    alert('Please generate a report first');
                }
            });
            
            printReportBtn.addEventListener('click', function() {
                // Prepare for printing
                prepareForPrinting();
                
                // Use setTimeout to allow the browser to render the charts before printing
                setTimeout(function() {
                    window.print();
                }, 500);
            });
        }
        
        // Function to prepare the report for printing
        function prepareForPrinting() {
            // Make sure all charts are properly rendered
            const reportGraphs = document.querySelectorAll('.report-graph canvas');
            reportGraphs.forEach(canvas => {
                // Ensure canvas is visible
                canvas.style.display = 'block';
                canvas.style.visibility = 'visible';
            });
        }
        
        // Global chart objects to keep track of them
        let reportCharts = {};
        
        function renderCustomReport(data, startDate, endDate) {
            const container = document.getElementById('customReportContainer');
            const formattedStartDate = new Date(startDate).toLocaleDateString();
            const formattedEndDate = new Date(endDate).toLocaleDateString();
            
            // Get checkbox states
            const includeVisits = document.getElementById('includeVisits').checked;
            const includeDocRequests = document.getElementById('includeDocRequests').checked;
            const includeDocStatus = document.getElementById('includeDocStatus').checked;
            const includeAiInsights = document.getElementById('includeAiInsights').checked;
            const includeUserQueries = document.getElementById('includeUserQueries').checked;
            const includeGraphs = document.getElementById('includeGraphs').checked;
            
            // Destroy any existing charts to prevent memory leaks
            Object.values(reportCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            reportCharts = {};
            
            let html = `
                <div class="report-header">
                    <h3>Barangay Amungan Chatbot Report</h3>
                    <p>Period: ${formattedStartDate} to ${formattedEndDate}</p>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                </div>
            `;
            
            // Website Visits Section
            if (includeVisits) {
                html += `
                    <div class="report-section">
                        <h4>Website Visits</h4>
                        <p>Total visits during this period: <strong>${data.totalVisits}</strong></p>
                `;
                
                if (includeGraphs) {
                    html += `<div id="visitsReportChart" class="report-graph"><canvas></canvas></div>`;
                }
                
                html += `
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Visits</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.visitsData.forEach(visit => {
                    html += `
                        <tr>
                            <td>${new Date(visit.visit_date).toLocaleDateString()}</td>
                            <td>${visit.visit_count}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Document Requests Section
            if (includeDocRequests) {
                html += `
                    <div class="report-section">
                        <h4>Document Requests</h4>
                        <p>Total document requests during this period: <strong>${data.totalRequests}</strong></p>
                `;
                
                if (includeGraphs) {
                    html += `<div id="docTypeReportChart" class="report-graph"><canvas></canvas></div>`;
                }
                
                html += `
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Document Type</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.documentTypesData.forEach(doc => {
                    const percentage = ((doc.total_requests / data.totalRequests) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td>${doc.document_type}</td>
                            <td>${doc.total_requests}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Document Status Section
            if (includeDocStatus) {
                html += `
                    <div class="report-section">
                        <h4>Document Status</h4>
                `;
                
                if (includeGraphs) {
                    html += `<div id="statusReportChart" class="report-graph"><canvas></canvas></div>`;
                }
                
                html += `
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.statusData.forEach(status => {
                    const percentage = ((status.count / data.totalDocuments) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td>${status.status}</td>
                            <td>${status.count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // AI Insights Section
            if (includeAiInsights && data.aiInsights) {
                html += `
                    <div class="report-section">
                        <h4>AI Insights</h4>
                        <div class="ai-insights">
                            ${data.aiInsights}
                        </div>
                    </div>
                `;
            }
            
            // Common User Queries Section
            if (includeUserQueries && data.topQueries && data.topQueries.length > 0) {
                html += `
                    <div class="report-section">
                        <h4>Common User Queries</h4>
                `;
                
                if (includeGraphs) {
                    html += `<div id="queriesReportChart" class="report-graph"><canvas></canvas></div>`;
                }
                
                html += `
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Query</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.topQueries.forEach(query => {
                    html += `
                        <tr>
                            <td>${query.query}</td>
                            <td>${query.count}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Create charts if graphs are enabled
            if (includeGraphs) {
                // Website Visits Chart
                if (includeVisits && data.visitsData.length > 0) {
                    const visitsChartElement = document.querySelector('#visitsReportChart canvas');
                    if (visitsChartElement) {
                        const ctx = visitsChartElement.getContext('2d');
                        reportCharts.visits = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.visitsData.map(item => new Date(item.visit_date).toLocaleDateString()),
                                datasets: [{
                                    label: 'Website Visits',
                                    data: data.visitsData.map(item => item.visit_count),
                                    borderColor: 'rgb(229, 57, 53)',
                                    backgroundColor: 'rgba(229, 57, 53, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }
                
                // Document Types Chart
                if (includeDocRequests && data.documentTypesData.length > 0) {
                    const docTypeChartElement = document.querySelector('#docTypeReportChart canvas');
                    if (docTypeChartElement) {
                        const ctx = docTypeChartElement.getContext('2d');
                        reportCharts.docTypes = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: data.documentTypesData.map(item => item.document_type),
                                datasets: [{
                                    data: data.documentTypesData.map(item => item.total_requests),
                                    backgroundColor: [
                                        'rgba(229, 57, 53, 0.7)',
                                        'rgba(198, 40, 40, 0.7)',
                                        'rgba(183, 28, 28, 0.7)',
                                        'rgba(136, 14, 79, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgb(229, 57, 53)',
                                        'rgb(198, 40, 40)',
                                        'rgb(183, 28, 28)',
                                        'rgb(136, 14, 79)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                    }
                                }
                            }
                        });
                    }
                }
                
                // Status Chart
                if (includeDocStatus && data.statusData.length > 0) {
                    const statusChartElement = document.querySelector('#statusReportChart canvas');
                    if (statusChartElement) {
                        const ctx = statusChartElement.getContext('2d');
                        reportCharts.status = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.statusData.map(item => item.status),
                                datasets: [{
                                    label: 'Document Status',
                                    data: data.statusData.map(item => item.count),
                                    backgroundColor: [
                                        'rgba(255, 193, 7, 0.7)',
                                        'rgba(40, 167, 69, 0.7)',
                                        'rgba(220, 53, 69, 0.7)',
                                        'rgba(0, 123, 255, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgb(255, 193, 7)',
                                        'rgb(40, 167, 69)',
                                        'rgb(220, 53, 69)',
                                        'rgb(0, 123, 255)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }
                
                // User Queries Chart
                if (includeUserQueries && data.topQueries && data.topQueries.length > 0) {
                    const queriesChartElement = document.querySelector('#queriesReportChart canvas');
                    if (queriesChartElement) {
                        const ctx = queriesChartElement.getContext('2d');
                        reportCharts.queries = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.topQueries.slice(0, 5).map(item => {
                                    // Truncate long queries for better display
                                    return item.query.length > 30 ? item.query.substring(0, 30) + '...' : item.query;
                                }),
                                datasets: [{
                                    label: 'Query Count',
                                    data: data.topQueries.slice(0, 5).map(item => item.count),
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    borderColor: 'rgb(54, 162, 235)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                scales: {
                                    x: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }
            }
            
            // Enable the print button
            document.getElementById('printReportBtn').disabled = false;
        }
    </script>
</body>
</html>
